# Implementation Plan: Bridge Content Script & Crawler Pipeline

## 1. Context & Goal
We need to close the gap between the Background script and the target web page. The Offscreen document cannot see the active tab's DOM to discover chapters and studies.
We will implement a **Content Script** to handle "Phase 1" (scanning the page structure, expanding chapters, collecting URLs) and pass this "Task List" to the Background, which will then feed the Offscreen Crawler.

## 2. Memory Update
Implemented the Content Script (`src/content/index.ts`) to handle DOM scraping and chapter expansion. Updated the messaging pipeline to flow: `Popup -> Background -> Content Script (Scrape) -> Background -> Offscreen (Crawl) -> Background (Enrich)`.

## 3. Step-by-Step Instructions

### Step 1: Create Content Script
**Action:** Create `src/content/index.ts`
**Description:**
- Implement the "Smart Expansion" logic from our previous `extractionMasterScript`.
- **Logic:**
    1.  Listen for `SCAN_PAGE` message from Background.
    2.  Iterate through `div[id^="chapter-"]`.
    3.  If closed, click header and **wait/poll** for content to appear.
    4.  Extract `CrawlTask` objects (Chapter Name, Study Name, URL).
    5.  Send response or `SCAN_COMPLETE` message back to Background with the list.
- **Constraints:** Use `async/await` for the UI interactions (clicking/waiting).

### Step 2: Register Content Script
**Action:** Modify `src/manifest.json`
**Description:**
- Add a `content_scripts` entry.
- **Matches:** `https://chessly.com/*`
- **File:** `src/content/index.ts`
- **Run At:** `document_idle`

### Step 3: Update Background Orchestrator
**Action:** Modify `src/background/index.ts`
**Description:**
- Update `handleStartCrawl`.
- **New Flow:**
    1.  Query active tab (`chrome.tabs.query({active: true, currentWindow: true})`).
    2.  Send `SCAN_PAGE` to that tab.
    3.  Wait for response containing `tasks: CrawlTask[]`.
    4.  *Then* call `setupOffscreenDocument`.
    5.  Send `START_CRAWL` to Offscreen, **passing the `tasks` array in the payload**.

### Step 4: Update Offscreen Crawler
**Action:** Modify `src/offscreen/crawler.ts`
**Description:**
- Update `startCrawl` signature or logic.
- **Change:** Remove the placeholder `collectStudyUrls`.
- **Input:** Expect `tasks` to be passed in the `START_CRAWL` message payload.
- **Flow:** `startCrawl(tasks)` -> `extractAllStudies(tasks)`.

### Step 5: Update Types
**Action:** Modify `src/types.ts`
**Description:**
- Update `Message` types to include `SCAN_PAGE` and `SCAN_COMPLETE`.
- Ensure payloads for `START_CRAWL` include `tasks: CrawlTask[]`.

## 4. Verification
1.  Run `npm run dev`.
2.  Reload extension in Chrome.
3.  Navigate to the Chessly Overview page.
4.  Open Extension Popup -> Click "Start".
5.  **Observe:** The page should scroll and chapters should open automatically (Content Script).
6.  **Observe:** The Popup status should change to "Crawling... (1/X)".
