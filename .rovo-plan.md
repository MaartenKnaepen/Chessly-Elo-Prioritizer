# Implementation Plan: Visible Worker & Deep JSON Extraction

## 1. Context & Goal
The extraction is failing silently because the Worker Tab is hidden and the "Analyze" button selector is unreliable.
We will **un-hide** the Worker Tab so you can visually verify the navigation. Simultaneously, we will upgrade the extractor to parse the raw Next.js data (JSON) directly, bypassing the need for UI buttons to appear.

## 2. Memory Update
Making Worker Tab visible for debugging. Replacing DOM-based move extraction with a robust `__NEXT_DATA__` JSON traversal to find PGN/Moves directly from the React state.

## 3. Step-by-Step Instructions

### Step 1: Make Worker Tab Visible
**Action:** Modify `src/background/index.ts`
**Description:**
- Update `processTaskQueue`:
    - Change `chrome.tabs.create` to use `{ active: true, pinned: false }`.
    - **Note:** This means the browser will focus the new tab. This is annoying but necessary to verify the URL is correct and the page loads.

### Step 2: Implement Deep JSON Extraction
**Action:** Modify `src/content/extractor.ts`
**Description:**
- **Add Function `extractFromNextData()`:**
    1.  Find `<script id="__NEXT_DATA__">`.
    2.  Parse JSON.
    3.  Implement a recursive search function `findKeys(obj, keyName)` to find any key matching `lines`, `moves`, or `pgn`.
- **Update `extractMoves`:**
    - Call `extractFromNextData()` *first*.
    - If that works, return the lines immediately.
    - Only fall back to `waitForAnalyzeButton` if JSON extraction fails.
    - **Logging:** Add `console.log` of the found JSON structure to help debug if it fails.

### Step 3: Fix Content Script Selector (Again)
**Action:** Modify `src/content/index.ts`
**Description:**
- The warnings `Chapter content did not appear` suggest the expansion check is failing.
- **Update `waitForChapterContent`:**
    - Instead of just checking `length > 0`, check if the container is `visible` (not `display: none`).
    - Increase `EXPANSION_DELAY_MS` to 1500ms to handle sluggish UI.

## 4. Verification
1.  Run `npm run build`.
2.  Reload Extension.
3.  **Action:** Open Chessly Overview -> "Start Extraction".
4.  **Observe:**
    - A new tab will open **in front of you**.
    - Watch the URL. Does it look correct? (e.g. `chessly.com/.../studies/...`)?
    - **Console:** Check the console *of that new tab* (F12) to see if "Found moves in JSON" appears.
    - The Dashboard should finally populate.
