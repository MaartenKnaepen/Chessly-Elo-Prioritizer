# Implementation Plan: Invisible API Crawler (Refactor)

## 1. Context & Goal
The current "Worker Tab" extraction is slow, brittle, and visually intrusive. We found that the Chessly API (`cag.chessly.com`) is accessible directly from the Content Script if `credentials: 'include'` is used.
We will refactor the extension to use **Direct API Fetching**. This allows us to delete the complex background tab management, resource blockers, and DOM scrapers, replacing them with a simple, invisible, and lightning-fast JSON parser.

## 2. Memory Update
Replacing the entire "Worker Tab" architecture with an "Invisible API Client" in the Content Script. Implementing a graph traversal algorithm to reconstruct chess lines from the raw API move graph. Removing obsolete files (`extractor.ts`, `interceptor.js`, `rules.json`).

## 3. Step-by-Step Instructions

### Step 1: Create API Crawler Service
**Action:** Create `src/content/api-crawler.ts`
**Description:**
- **Function `fetchStudyData(studyUrl)`:**
    - Extract UUID from URL.
    - Fetch `https://cag.chessly.com/beta/openings/courses/studies/${uuid}/moves` with `credentials: 'include'`.
    - **Graph Traversal Logic:** Implement the *Optimized* parser:
        - Recursive DFS with `visitedFens` (Set) to prevent cycles.
        - `uniqueMoves` (Map) to deduplicate variations at each node.
        - Return `RawExtractedLine[]`.

### Step 2: Integrate into Content Script
**Action:** Modify `src/content/index.ts`
**Description:**
- **Remove:** `SCAN_COMPLETE` message sending (we will handle it all here).
- **New Flow:**
    1.  Scan page for Chapters/Studies (Phase 1).
    2.  Loop through the list.
    3.  Call `fetchStudyData` for each study *immediately* (with small 200ms delay to be polite).
    4.  Send `STUDY_EXTRACTED` message to Background for each result.
    5.  Send `CRAWL_COMPLETE` when loop finishes.
- **UI:** Show a small toast notification on the page ("Extracted Study X/Y") so the user knows it's working.

### Step 3: Clean Background Script
**Action:** Modify `src/background/index.ts`
**Description:**
- **Remove:** `processTaskQueue`, `workerTabId`, `enableWorkerTabBlocking`, `waitForExtractorReady`.
- **Remove:** `handleScanComplete` (no longer needed, Content Script drives the loop).
- **Keep:** `handleStudyExtracted` (Enrichment Queue) and `handleStartCrawl` (State reset).
- **Update:** `handleStartCrawl` just sends `SCAN_PAGE` to the active tab.

### Step 4: Delete Obsolete Files
**Action:** Delete `src/content/extractor.ts`.
**Action:** Delete `src/content/interceptor.js`. (If it still exists)
**Action:** Delete `src/rules.json`. (If it still exists)
**Action:** Modify `src/manifest.json`:
    - Remove the second `content_scripts` entry (the one for `extractor.ts`).
    - Remove `declarativeNetRequest` permission and `rule_resources`.
    - Remove `tabs` permission (no longer opening tabs).

### Step 5: Update Types
**Action:** Modify `src/types.ts`
**Description:**
- Remove `EXTRACT_MOVES` and `EXTRACTOR_READY` message types.

## 4. Verification
1.  Run `npm run build`.
2.  Reload Extension.
3.  **Test:** Click "Start Extraction".
4.  **Observe:**
    - **No new tabs open.**
    - The Dashboard fills up *very* fast.
    - The "Unknown Study" names should be gone (since we fixed the scan logic previously).
    - Network tab (F12) shows successful calls to `cag.chessly.com`.
