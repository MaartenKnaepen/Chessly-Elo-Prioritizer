# Implementation Plan: Fix Reload Loop & View Logic

## 1. Context & Goal
The user reported two issues:
1.  **Reload Loop:** The extension reloads the page after scanning, which is annoying and unnecessary.
2.  **UI State Issue:** The extension fails to reappear or switch modes correctly (e.g., sticking to the "Table View" when it should show the "Scanner," or not reappearing after being closed).

We will remove the forced page reload and refine the `runAnalysis` logic to correctly detect and switch between "Lesson Mode" (Full Table) and "Course Mode" (Scanner Only). We will also add a `showSuccess` method to the renderer for better feedback.

## 2. Memory Update
Removing `window.location.reload()` from the scan workflow and improving the `runAnalysis` state machine to correctly handle transitions between Lesson and Course Overview pages. Added `showSuccess` to `renderer.js`.

## 3. Step-by-Step Instructions

### Step 1: `renderer.js`
**Action:** Modify
**Description:**
- Add a new function `showSuccess(msg)` to `ChesslyRenderer` to display success messages in green (instead of using the red `showError` template).

**Code to Add (inside `ChesslyRenderer` object, after `showError`):**
```javascript
    showSuccess: function(msg) {
        this.createOrUpdateContainer(`
            <div style="padding:15px; color:#86c246; text-align:center; font-size:13px;">
                <div style="margin-bottom:5px;">✅ Success</div>
                <div style="font-size:11px; color:#ccc;">${msg}</div>
            </div>
        `);
    },
```

### Step 2: `content.js`
**Action:** Modify
**Description:**
- **Remove Reload:** In the `ChesslyScanCourse` event listener, remove the `setTimeout` that triggers `window.location.reload()`. Replace `showError` with `showSuccess`.
- **Fix Mode Switching:** Update `runAnalysis` to correctly handle the transition from "Full Table" to "Scanner Only".

**Modifications:**

**A. Inside `document.addEventListener('ChesslyScanCourse', ...)`:**
```javascript
        // ... inside try block ...
        // Replace this section:
        /*
        ChesslyRenderer.showError("✅ Course scan complete!<br>Reloading in 1 second...");
        const scanBtn = document.getElementById("chessly-scan-btn");
        if (scanBtn) { scanBtn.classList.remove("chessly-scanning"); }
        setTimeout(() => { window.location.reload(); }, 1000);
        */

        // With this:
        ChesslyRenderer.showSuccess("Course scan complete!");
        
        const scanBtn = document.getElementById("chessly-scan-btn");
        if (scanBtn) {
            scanBtn.classList.remove("chessly-scanning");
        }
        // No reload
```

**B. Inside `async function runAnalysis()`, update the Course Overview check:**
```javascript
    // ... inside if (!analyzeLink) block ...
    
    if (chapterLinks.length > 0) {
        // Mode Check:
        const isFullMode = document.getElementById('chessly-table-content');
        const isScannerMode = document.getElementById('chessly-scan-btn') && !isFullMode;

        // If we are already in the correct mode (Scanner Only), stop.
        if (isScannerMode) {
            isAnalyzing = false;
            return;
        }
        
        // Otherwise (No UI, or Wrong UI i.e. Full Table), draw the scanner.
        ChesslyRenderer.drawScannerOnly();
    }
    
    // ...
```

## 4. Verification
1.  **Reload Extension:** Go to `chrome://extensions` and click the refresh icon.
2.  **Test Scan:** On a Course Overview page, click the Scan button.
    *   **Verify:** Progress bar fills, "Success" message appears (Green).
    *   **Verify:** Page **DOES NOT** reload.
3.  **Test Navigation:**
    *   Go to a Lesson (verify Full Table appears).
    *   Go back to Course Overview (verify UI switches to Scanner Only).

4. CRITICAL RULES
- Do not output the .rovo-plan.md block until the discussion is finished.
- Be specific: "Update logic.js" is bad. "Update recursiveTreeBuilder in logic.js to handle null inputs" is good.
- File Paths: Always use the paths shown in the ### PROJECT STRUCTURE ###.
- Hallucination Check: Do not invent files that are not in the file tree unless you are explicitly creating them in a step.
