# Implementation Plan: Main World Interceptor & Rule Cleanup

## 1. Context & Goal
The Network Interceptor is missing the critical data fetch because it loads too late (after the page has already started fetching).
We will move the interceptor to be a **Native Content Script** running in the `MAIN` world (Chrome 111+ feature). This guarantees it runs before the page's own JavaScript, capturing 100% of network traffic. We will also add code to ensure blocking rules are cleared on startup.

## 2. Memory Update
Upgrading `interceptor.js` to a Manifest-registered `MAIN` world script for immediate execution. Adding explicit rule cleanup logic to Background initialization.

## 3. Step-by-Step Instructions

### Step 1: Update Manifest for Main World
**Action:** Modify `src/manifest.json`
**Description:**
- Add a new entry to `content_scripts`.
- **Matches:** `https://chessly.com/*`
- **File:** `src/content/interceptor.js`
- **Run At:** `document_start` (Critical!)
- **World:** `MAIN` (Critical! Allows patching `window.fetch`).
- **Clean Up:** Remove `src/content/interceptor.js` from `web_accessible_resources` (no longer needed).

### Step 2: Cleanup Extractor Script
**Action:** Modify `src/content/extractor.ts`
**Description:**
- Remove the code that manually injects `interceptor.js` (the `document.createElement('script')` block).
- Keep the `window.addEventListener('message', ...)` logic (this stays the same).

### Step 3: Debug the Interceptor
**Action:** Modify `src/content/interceptor.js`
**Description:**
- **Add Logging:** Log *every* URL fetched to the console (not just the ones matching `/study`).
    - `console.log('ðŸ“¡ Fetch:', url);`
- **Relax Filter:** Make the check broader. If it contains `trpc` or `batch`, log it as a potential candidate.
- **Pass Through:** Ensure we catch `lines` inside nested objects if the API response changed format.

### Step 4: Ensure Background Cleanup
**Action:** Modify `src/background/index.ts`
**Description:**
- Verify the `initializeState` function has the rule clearing logic.
- Add a log message: `console.log("ðŸ§¹ Background Startup: Ensuring rules are cleared...");`

## 4. Verification
1.  Run `npm run build`.
2.  Reload Extension.
3.  **Check Background Console:** Ensure "Rules Nuked" message appears (or runs automatically).
4.  **Run Extraction:**
    - Worker Tab opens.
    - Open Worker Tab DevTools (F12) -> Console.
    - **Observe:** You should see `ðŸ“¡ Fetch: ...` logs *immediately* as the page loads.
    - You should see `âœ… Found move data` when the study loads.
