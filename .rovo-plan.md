# Implementation Plan: Fix API Graph Parser

## 1. Context & Goal
The API fetcher is working (`credentials: 'include'` success!), but the parser fails because the API returns a raw dictionary of FENs, not a `{ moves: [] }` wrapper.
We will update `src/content/api-crawler.ts` to parse this Dictionary-based Graph correctly.

## 2. Memory Update
Updating `parseMovesGraph` to handle a `Record<string, ApiMove[]>` structure instead of an array. Implementing traversal starting from the standard chess starting FEN.

## 3. Step-by-Step Instructions

### Step 1: Update Interfaces
**Action:** Modify `src/content/api-crawler.ts`
**Description:**
- Update `ApiMove` interface to match the actual data:
    ```typescript
    interface ApiMove {
      san: string;      // "e4"
      nextFen: string;  // Pointer to next key
      fen: string;      // Current FEN (redundant but present)
      // ... other fields
    }
    ```
- Update `StudyApiResponse`:
    ```typescript
    type StudyApiResponse = Record<string, ApiMove[]>;
    ```

### Step 2: Update Parser Logic
**Action:** Modify `src/content/api-crawler.ts`
**Description:**
- **In `fetchStudyData`:**
    - Remove the check `if (!data.moves || !Array.isArray(data.moves))`.
    - Instead, check `if (typeof data !== 'object')`.
    - Pass the whole `data` object to `parseMovesGraph`.
- **In `parseMovesGraph`:**
    - Change input type to `Record<string, ApiMove[]>`.
    - Define `const START_FEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";`.
    - **Traversal:**
        - Start at `graph[START_FEN]`.
        - If `graph[START_FEN]` is undefined, try to find a key that looks like a start position (rare, but safety fallback: maybe sort keys by length?).
        - Recursively follow `move.nextFen`.

## 4. Verification
1.  Run `npm run build`.
2.  Reload Extension.
3.  Refresh Chessly page.
4.  Start Extraction.
5.  **Observe:** "Extracted X variations" logs should appear in the console. Dashboard should fill up.
