# Implementation Plan: Turbo Worker Tab & Resource Blocking

## 1. Context & Goal
The Offscreen Iframe approach failed due to Same-Origin Policy (SecurityError). We will replace it with a **"Worker Tab"** managed by the Background script. To maintain high performance, we will implement **Network Blocking** to strip images, media, and trackers from the worker tab, ensuring it loads instantly.

## 2. Memory Update
Replaced Offscreen Crawler with a Background Worker Tab architecture. Implemented `src/content/extractor.ts` to handle per-study extraction. Configured `declarativeNetRequest` to block heavy assets on Chessly for speed.

## 3. Step-by-Step Instructions

### Step 1: Create Extractor Script
**Action:** Create `src/content/extractor.ts`
**Description:**
- Logic is similar to the previous `fetchWithTimeout` but runs inside the page.
- **Trigger:** Runs automatically when the page loads (if it matches a Study URL).
- **Logic:**
    1.  Check if this is an "Extraction Run" (via session storage or URL param?). *Better:* Listen for a `EXTRACT_MOVES` message from Background.
    2.  Poll for the "Analyze" button (max 5s).
    3.  Extract lines.
    4.  Send `STUDY_EXTRACTED` message to Background.

### Step 2: Register Extractor
**Action:** Modify `src/manifest.json`
**Description:**
- Add `src/content/extractor.ts` to `content_scripts`.
- **Matches:** `https://chessly.com/*/studies/*` (Specific to studies).
- **Run At:** `document_idle`.

### Step 3: Implement Resource Blocker
**Action:** Create `src/rules.json` and update `manifest.json`
**Description:**
- **File:** Create a JSON file defining blocking rules.
- **Rules:** Block `image`, `media`, `font`, `websocket` (optional) on `chessly.com`.
- **Manifest:** Register `declarative_net_request` ruleset.

### Step 4: Update Background Orchestrator
**Action:** Modify `src/background/index.ts`
**Description:**
- **Remove:** `setupOffscreenDocument` (Delete `src/offscreen` entirely later).
- **Add:** `TaskQueue` state (list of URLs to visit).
- **Add:** `workerTabId` state.
- **Logic (`processTaskQueue`):**
    1.  If no `workerTabId`, create one (`active: false`, `pinned: true`).
    2.  Update tab URL: `chrome.tabs.update(workerTabId, { url: nextTask.url })`.
    3.  Wait for `chrome.tabs.onUpdated` (status: complete).
    4.  Send `EXTRACT_MOVES` to the tab.
    5.  Wait for `STUDY_EXTRACTED` response.
    6.  Repeat.
    7.  Close tab when done.

### Step 5: Update Types
**Action:** Modify `src/types.ts`
**Description:**
- Add `EXTRACT_MOVES` message type.

## 4. Verification
1.  Run `npm run build`.
2.  Reload Extension.
3.  Start Extraction.
4.  **Observe:** A pinned tab should open in the background. It should cycle through URLs rapidly.
5.  **Observe:** The Dashboard should fill up with data.
